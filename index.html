<html lang="en">
    <head>
        <title>音頭難易度表</title>
        <meta name="bmstable" content="header.json" />

        <!-- Tabulator -->
        <link href="https://unpkg.com/tabulator-tables@4.2.4/dist/css/tabulator.min.css" rel="stylesheet" />
        <script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.2.4/dist/js/tabulator.min.js" ></script>

        <meta http-equiv="Pragma" content="no-cache">
        <meta http-equiv="Cache-Control" content="no-cache">
        <meta http-equiv="Expires" content="0">
    </head>
    <body>
        <a href="https://kju8.github.io/ondo_calculator/index.html">音頭計算機</a>
        <div id="table"></div>
    </body>

    <script>
        const empty_text = function(text){
            return !(text && String(text).replace(/&nbsp;|&nbsp/g ,' ').match(/\S/g));
        }

        const request = new XMLHttpRequest();
        request.onload = objs => {
            const header = JSON.parse(request.responseText);
            const table = new Tabulator("#table", {
                height:"99%",
                layout: "fitColumns",
                groupBy: "level",
                responsiveLayout:"collapse",
                responsiveLayoutCollapseStartOpen:false,
                groupHeader: function(value, count, data, group){
                    return `<span>${header.symbol}${value} (${count} pattern)</span>`;
                },
                columns: [
                    {formatter:"responsiveCollapse", field:"collapse", width:30, minWidth:30, align:"center", resizable:false, headerSort:false},
                    { title: "Level", field: "level", width: 100, resizable: false,
                        formatter: function(cell, formatterParams, onRendered) {
                            return header.symbol + cell.getValue();
                        },
                    },
                    { title: "Name", field: "title", minWidth: 1, headerSort:false, resizable: false, variableHeight:true,
                        formatter: function(cell, formatterParams, onRendered) {
                            cell.getElement().style.whiteSpace = "pre-wrap";
                            const value = cell.getValue();
                            const data = cell.getRow().getData();
                            const md5 = data.md5;
                            return `<a href="http://www.dream-pro.info/~lavalse/LR2IR/search.cgi?mode=ranking&bmsmd5=${md5}" target="_blank">${value}</a>`
                        },
                    },
                    { title: "Artist", field: "artist", minWidth: 100, headerSort:false, resizable: false,
                        formatter: function(cell, formatterParams, onRendered) {
                            cell.getElement().style.whiteSpace = "pre-wrap";
                            const value = cell.getValue();
                            const data = cell.getRow().getData();
                            const url = data.url;
                            if(url){
                                return `<a href="${url}" target="_blank">${value}</a>`
                            }
                            return value;
                        },
                    },
                    { title: "OND-ize", field: "name_diff", formatter:"textarea", minWidth: 100, headerSort:false, resizable: false,
                        formatter: function(cell, formatterParams, onRendered) {
                            cell.getElement().style.whiteSpace = "pre-wrap";
                            const value = cell.getValue();
                            const data = cell.getRow().getData();
                            const url = data.url_diff;
                            if(url){
                                return `<a href="${url}" target="_blank">${value}</a>`
                            }
                            return value;
                        },
                    },
                    { title: "Original Title", field: "original_title", minWidth: 10000, headerSort:false, resizable: false},
                    { title: "BPM Ratio", field: "bpm_ratio", minWidth: 10000, headerSort:false, resizable: false},
                    { title: "Comment", field: "html_comment", minWidth: 10000, headerSort:false, resizable: false, formatter: "html"},
                ],
                responsiveLayoutCollapseFormatter:function(data){
                    //data - an array of objects containing the column title and value for each cell
                    var list = document.createElement("ul");

                    data.forEach(function(col){
                        if(!empty_text(col.value)){
                            let item = document.createElement("li");
                            item.innerHTML = "<strong>" + col.title + "</strong> - " + col.value;
                            list.appendChild(item);
                        }
                    });

                    return Object.keys(data).length ? list : "";
                },
                rowFormatter:function(row){
                    var data = row.getData();

                    if(empty_text(data.original_title) && empty_text(data.bpm_ratio) && empty_text(data.html_comment)){
                        console.log("check Through");
                        data.getCell("collapse").getElement().innerHTML = "";
                    }
                }
            });

            table.setData("./data.json");
        };
        request.open("get", "header.json", true);
        request.setRequestHeader('Pragma', 'no-cache');
        request.setRequestHeader('Cache-Control', 'no-cache');
        request.setRequestHeader('If-Modified-Since', 'Thu, 01 Jun 1970 00:00:00 GMT')
        request.send();
    </script>
</html>
